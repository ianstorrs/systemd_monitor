# Systemd Monitor

`systemd_monitor.py` is a Python script designed to monitor the state of specified systemd services on a Linux system. It leverages D-Bus to listen for signals related to service changes (like `ActiveState`, `SubState`, `JobNew`, `JobRemoved`) and also periodically polls services to ensure state consistency. All monitored events are logged to a file, and the script can generate statistics on service crashes, restarts, starts, and stops.

## Features

*   **Real-time Monitoring**: Uses D-Bus signals for immediate notifications of service state changes.
*   **Periodic Polling**: Supplements signal-based monitoring with periodic polling for robustness.
*   **Configurable Logging**: Logs service events to a specified file (default: `systemd_monitor.log`).
*   **Statistics Generation**: Parses log files to provide a summary of service activities, including crashes, restarts, starts, and stops.
*   **Specific Service Targeting**: Monitors a predefined set of services.
*   **Debug Mode**: Offers a `--debug` flag for verbose logging, useful for troubleshooting.
*   **Graceful Shutdown**: Handles `Ctrl+C` (SIGINT) to stop monitoring, generate final statistics, and exit cleanly.

## How it Works

The script operates in two main capacities:

1.  **`DBusMonitor`**:
    *   Connects to the system D-Bus.
    *   Subscribes to systemd manager signals (`UnitNew`, `JobNew`, `JobRemoved`).
    *   For each monitored service, it subscribes to `PropertiesChanged` signals to track changes in `ActiveState` and `SubState`.
    *   Periodically polls the state of registered units to catch any missed signals or ensure current state accuracy.
    *   Logs all relevant events with timestamps, service name, state, substate, and source (signal, poll, etc.).

2.  **`StatsAnalyzer`**:
    *   Parses the log file generated by `DBusMonitor`.
    *   Aggregates data to count occurrences of crashes, restarts, starts, and stops for each monitored service.
    *   Prints a formatted table of these statistics to the console.

The `SystemdMonitor` class orchestrates these two components, running the D-Bus monitoring in one thread and periodically generating statistics in another.

## Monitored Services

The script is hardcoded to monitor the following services:

```
wirepas-gateway.service
wirepas-sink-ttys1.service
wirepas-sink-ttys2.service
edger.connecteddev.service
edger.endries.service
devmgmt.service
hwcheck.service
provisioning.service
Node-Configuration.service
setup_cell_connect.service
wps_button_monitor.service
mosquitto.service
```

To change the list of monitored services, you would need to modify the `MONITORED_SERVICES` set within the `systemd_monitor.py` script.

## Prerequisites

*   Python 3
*   `python-dbus` (or `python3-dbus`)
*   `python-gi` (or `python3-gi`, `gir1.2-glib-2.0`)

These can typically be installed via your system's package manager. For example, on a Debian-based system:
```bash
sudo apt-get update
sudo apt-get install python3 python3-dbus python3-gi
```

## Usage

1.  **Ensure the script is executable**:
    ```bash
    chmod +x systemd_monitor.py
    ```

2.  **Run the script**:
    ```bash
    ./systemd_monitor.py
    ```

3.  **Run with debug logging**:
    ```bash
    ./systemd_monitor.py --debug
    ```

The script will start monitoring the services and logging events to `systemd_monitor.log` in the same directory. Statistics will be printed to the console periodically (every 60 seconds by default) and upon exiting the script.

To stop the monitor, press `Ctrl+C`. It will then perform a final statistics generation before exiting.

## Output

*   **Log File (`systemd_monitor.log`)**: Contains detailed entries for each detected service event.
    Example log entry:
    ```
    2023-10-27 10:00:00,123 - INFO - Service: wirepas-gateway, State: active, SubState: running, Source: PropertiesChanged
    ```
*   **Console Output**: Periodically displays statistics for monitored services.
    Example statistics output:
    ```
    Statistics from systemd_monitor.log:
    Service                   Crashes    Restarts   Starts     Stops
    -----------------------------------------------------------------
    wirepas-gateway           0          0          5          4
    mosquitto                 1          1          2          1
    ...
    ```

## Signal Handling

The script includes signal handlers for `SIGINT` (Ctrl+C) to ensure a graceful shutdown. An early signal handler is also in place to catch `Ctrl+C` even during the import phase or initial setup.
